name: 'Test Custom Actions'

# é€™å€‹ workflow ç¤ºç¯„å¦‚ä½•ä½¿ç”¨è‡ªè¨‚çš„ JavaScript å’Œ Container Actions

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# è¨­å®šæœ€å°æ¬Šé™
permissions:
  contents: read

jobs:
  # Job 1: æ¸¬è©¦ JavaScript Action
  test-javascript-action:
    name: 'æ¸¬è©¦ JavaScript Action'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£ JavaScript Action ä¾è³´
        run: |
          cd .github/actions/javascript-action
          npm install
      
      - name: åŸ·è¡Œ JavaScript Action - åŸºæœ¬ä½¿ç”¨
        id: js-basic
        uses: ./.github/actions/javascript-action
        with:
          who_to_greet: 'GitHub Actions ä½¿ç”¨è€…'
          message_prefix: 'æ­¡è¿'
      
      - name: é¡¯ç¤º JavaScript Action è¼¸å‡º
        run: |
          echo "ğŸ‰ å•å€™è¨Šæ¯: ${{ steps.js-basic.outputs.greeting-message }}"
          echo "â° åŸ·è¡Œæ™‚é–“: ${{ steps.js-basic.outputs.time }}"
          echo "ğŸŒ ç’°å¢ƒè®Šæ•¸: $CUSTOM_GREETING"
      
      - name: åŸ·è¡Œ JavaScript Action - ä¸åŒåƒæ•¸
        id: js-custom
        uses: ./.github/actions/javascript-action
        with:
          who_to_greet: 'Open Source ç¤¾ç¾¤'
          message_prefix: 'Hi'
      
      - name: ä½¿ç”¨ JavaScript Action è¼¸å‡º
        run: |
          echo "è¨Šæ¯: ${{ steps.js-custom.outputs.greeting-message }}"

  # Job 2: æ¸¬è©¦ Container Action
  test-container-action:
    name: 'æ¸¬è©¦ Container Action'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: åŸ·è¡Œ Container Action - å¤§å¯«è½‰æ›
        id: container-upper
        uses: ./.github/actions/container-action
        with:
          text_to_process: 'hello github actions'
          operation: 'uppercase'
          output_format: 'text'
      
      - name: é¡¯ç¤º Container Action è¼¸å‡º
        run: |
          echo "ğŸ“¥ åŸå§‹æ–‡å­—: ${{ steps.container-upper.outputs.original }}"
          echo "ğŸ“¤ è™•ç†çµæœ: ${{ steps.container-upper.outputs.result }}"
          echo "ğŸ”§ ä½¿ç”¨æ“ä½œ: ${{ steps.container-upper.outputs.operation-used }}"
          echo "ğŸŒ ç’°å¢ƒè®Šæ•¸: $PROCESSED_TEXT"
      
      - name: åŸ·è¡Œ Container Action - å°å¯«è½‰æ›
        id: container-lower
        uses: ./.github/actions/container-action
        with:
          text_to_process: 'HELLO WORLD'
          operation: 'lowercase'
          output_format: 'text'
      
      - name: åŸ·è¡Œ Container Action - åè½‰æ–‡å­—
        id: container-reverse
        uses: ./.github/actions/container-action
        with:
          text_to_process: 'GitHub Actions'
          operation: 'reverse'
          output_format: 'json'
      
      - name: é¡¯ç¤ºåè½‰çµæœ
        run: |
          echo "åè½‰çµæœ: ${{ steps.container-reverse.outputs.result }}"

  # Job 3: æ•´åˆæ¸¬è©¦
  integration-test:
    name: 'æ•´åˆæ¸¬è©¦ - çµ„åˆä½¿ç”¨å…©ç¨® Actions'
    runs-on: ubuntu-latest
    needs: [test-javascript-action, test-container-action]
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£ä¾è³´
        run: |
          cd .github/actions/javascript-action
          npm install
      
      - name: æ­¥é©Ÿ 1 - JavaScript Action ç”¢ç”Ÿè¨Šæ¯
        id: generate
        uses: ./.github/actions/javascript-action
        with:
          who_to_greet: 'æ•´åˆæ¸¬è©¦'
          message_prefix: 'Welcome to'
      
      - name: æ­¥é©Ÿ 2 - Container Action è™•ç†è¨Šæ¯
        id: process
        uses: ./.github/actions/container-action
        with:
          text_to_process: ${{ steps.generate.outputs.greeting-message }}
          operation: 'uppercase'
          output_format: 'text'
      
      - name: æ­¥é©Ÿ 3 - é¡¯ç¤ºæœ€çµ‚çµæœ
        run: |
          echo "=== æ•´åˆæ¸¬è©¦çµæœ ==="
          echo "åŸå§‹è¨Šæ¯: ${{ steps.generate.outputs.greeting-message }}"
          echo "è™•ç†å¾Œ: ${{ steps.process.outputs.result }}"
          echo "========================"

  # Job 4: Matrix æ¸¬è©¦ - æ‰¹æ¬¡è™•ç†
  matrix-test:
    name: 'Matrix æ¸¬è©¦'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        text: ['Hello', 'GitHub', 'Actions']
        operation: ['uppercase', 'lowercase', 'reverse']
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è™•ç†æ–‡å­— - ${{ matrix.text }} with ${{ matrix.operation }}
        id: matrix-process
        uses: ./.github/actions/container-action
        with:
          text_to_process: ${{ matrix.text }}
          operation: ${{ matrix.operation }}
          output_format: 'text'
      
      - name: é¡¯ç¤ºçµæœ
        run: |
          echo "æ–‡å­—: ${{ matrix.text }}"
          echo "æ“ä½œ: ${{ matrix.operation }}"
          echo "çµæœ: ${{ steps.matrix-process.outputs.result }}"

  # Job 5: éŒ¯èª¤è™•ç†æ¸¬è©¦
  error-handling-test:
    name: 'éŒ¯èª¤è™•ç†æ¸¬è©¦'
    runs-on: ubuntu-latest
    continue-on-error: true  # å…è¨±æ­¤ job å¤±æ•—
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: æ¸¬è©¦ç„¡æ•ˆæ“ä½œ (é æœŸæœƒå¤±æ•—)
        id: invalid-op
        uses: ./.github/actions/container-action
        continue-on-error: true
        with:
          text_to_process: 'test'
          operation: 'invalid-operation'
      
      - name: æª¢æŸ¥éŒ¯èª¤è™•ç†
        if: steps.invalid-op.outcome == 'failure'
        run: |
          echo "âœ… éŒ¯èª¤è™•ç†æ­£å¸¸ - Action æ­£ç¢ºåœ°å›å ±äº†éŒ¯èª¤"
          exit 0
      
      - name: å¦‚æœæ²’æœ‰å¤±æ•—å‰‡å ±å‘Šç•°å¸¸
        if: steps.invalid-op.outcome == 'success'
        run: |
          echo "âŒ éŒ¯èª¤è™•ç†ç•°å¸¸ - Action æ‡‰è©²è¦å¤±æ•—ä½†æˆåŠŸäº†"
          exit 1
